<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta charset="utf-8" />
  <title>Дневник эмоций с выезжающим меню</title>
  <style>
    :root{
      --bg:#1a1a2e;
      --card:#2a2a3e;
      --muted:#9aa3b2;
      --neg:#2b5278;
      --rat:#3b3d42;
      --text:#e6e6e6;
      --accent:#4A90E2;
    }
    body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
    body.menu-open { overflow: hidden; }
    
    .grid{ display:grid; grid-template-columns:1fr; gap:0; max-width: 800px; margin: 0 auto; transition: transform 0.3s ease; }
    .side-section { display: none !important; }
    .section { display: flex; flex-direction: column; position: relative; height: 100vh; padding-bottom: 0; }
    .chat-area{ background:rgba(0,0,0,0.00); padding:14px 14px 80px 14px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; flex: 1; }
    
    .chat-message, .chat-message-group { -webkit-user-select: none; user-select: none; }
    .chat-message{ display:block; max-width: 400px; padding:10px 14px; border-radius:14px; word-break:break-word; line-height:1.35; cursor: pointer; }
    .chat-message.neg { margin-left:auto; background:var(--neg); color:#fff; border-bottom-right-radius:6px; }
    .chat-message.rat { margin-right:auto; background:var(--rat); color:#fff; border-bottom-left-radius:6px; }
    .meta-row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; color:var(--muted); font-size:12px; }
    .meta-row.rat-meta { justify-content: flex-start; }

    .icon-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
    .icon-btn.ghost{ opacity:0.9; }
    .side-drawer{ position:fixed; top:0; left:-220px; width:200px; height:100%; background:var(--card); padding:10px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left 0.3s; z-index:1000; overflow-y:auto; }
    .side-drawer.open{ left:0; }
    .chat-item{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--text); margin-bottom:6px; }
    .chat-item.active{ background:var(--accent); color:#fff; }
    .cheat-item{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer; color:var(--text); }
    .note{ color:var(--muted); font-size:13px; padding: 14px; text-align: center; }
    .menu-btn { position: fixed; top: 10px; left: 10px; width: 36px; height: 36px; font-size: 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(4px); z-index: 2000; cursor: pointer; }
    .side-drawer h3 { margin-left: 0; }
    
    .fixed-input, #openDistBtn { display: none !important; }

    #distortionPanel { position: fixed; left: 0; right: 0; bottom: 0; height: 60vh; background: var(--card); border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -4px 15px rgba(0,0,0,0.4); padding: 16px; z-index: 5000; transform: translateY(100%); transition: transform 0.3s ease; overflow-y: auto; }
    #distortionPanel.open { transform: translateY(0); }
    .close-distortion { position: absolute; top: 8px; right: 12px; font-size: 22px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
    .close-distortion:hover { opacity: 1; }

    .grid.shifted { transform: translateX(110px); }

    @media(max-width:800px){ 
      .grid, .grid.shifted { max-width: 100vw; margin: 0; transform: translateX(0); }
      .chat-message { max-width: 85%; }
      .content-shifted { transform: translateX(220px) !important; }
    }

    .context-menu-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 4000; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
    .context-menu-overlay.open { opacity: 1; pointer-events: auto; }
    .context-menu { position: fixed; background: var(--card); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 4001; opacity: 0; transform: scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease; transform-origin: top left; }
    .context-menu.open { opacity: 1; transform: scale(1); }
    .menu-item { padding: 10px 16px; cursor: pointer; font-size: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: rgba(255,255,255,0.05); }

    #inputModalOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 6000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #inputModalOverlay.open { opacity: 1; pointer-events: auto; }
    #inputModal {
        position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 16px;
        z-index: 6001; transform: translateY(100%); transition: transform 0.3s ease;
        border-top-left-radius: 16px; border-top-right-radius: 16px;
        display: flex; flex-direction: column; gap: 10px;
    }
    #inputModal.open { transform: translateY(0); }
    .input-modal-header { display: flex; justify-content: space-between; align-items: center; }
    .input-modal-actions { display: flex; gap: 8px; }
    .input-modal-text {
      padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); width: 100%;
      resize: none; overflow-y: auto; max-height: 150px; transition: height 0.1s ease-out; box-sizing: border-box;
    }
    .input-modal-num {
      width:70px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); text-align:center;
      -webkit-appearance: none; appearance: none;
    }
    .input-modal-num::-webkit-outer-spin-button, .input-modal-num::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

  </style>
</head>
<body>

  <div id="distortionPanel">
    <div id="distortionContent"></div>
    <span class="close-distortion" onclick="closeDistortionPanel()">×</span>
  </div>
  
  <button class="icon-btn menu-btn" id="menuBtn">☰</button>

  <div class="side-drawer" id="sideDrawer">
    <h3>Чаты</h3>
    <div id="chatListArea"></div>
    <button class="icon-btn" id="newChatBtn" style="margin-top:10px;">+ Новый чат</button>
  </div>

  <div class="grid" id="mainGrid">
    <div class="section">
        <div id="chatArea" class="chat-area" aria-live="polite"></div>
    </div>
    <aside class="side-section"></aside>
  </div>

  <!-- Контекстное меню -->
  <div class="context-menu-overlay" id="contextMenuOverlay"></div>
  <div class="context-menu" id="contextMenu"></div>

  <!-- Модальное окно ввода -->
  <div id="inputModalOverlay"></div>
  <div id="inputModal">
    <div class="input-modal-header">
        <h4 id="inputModalTitle">Новая мысль</h4>
        <div class="input-modal-actions">
            <input id="inputModalPct" class="input-modal-num" type="number" min="0" max="100" placeholder="На %" />
            <button id="inputModalSendBtn" class="icon-btn send-btn">➤</button>
        </div>
    </div>
    <textarea id="inputModalText" class="input-modal-text" placeholder="Опиши мысль..." rows="3"></textarea>
  </div>


  <script>
    /* ====== State ====== */
    const STORAGE_KEY = "diary_chat_v3";
    const CHEATS = ["Катастрофизация", "Чтение мыслей", "Чёрно-белое мышление", "Эмоциональное обоснование", "Долженствование", "Обесценивание положительного", "Генерализация", "Персонализация", "Фильтрация отрицательного", "Завышенные стандарты"];
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { chats: [{ id: "chat1", name: "Чат 1", thoughts: [] }], activeChatId: "chat1" };
    let inputModalMode = { type: 'newThought', tIdx: null, rIdx: null }; 

    /* ====== UI elements ====== */
    const chatArea = document.getElementById("chatArea");
    const sideDrawer = document.getElementById("sideDrawer");
    const menuBtn = document.getElementById("menuBtn");
    const mainGrid = document.getElementById("mainGrid");
    const chatListArea = document.getElementById("chatListArea");
    const distortionPanel = document.getElementById("distortionPanel");
    const distortionContent = document.getElementById("distortionContent");
    const contextMenu = document.getElementById("contextMenu");
    const contextMenuOverlay = document.getElementById("contextMenuOverlay");
    const inputModal = document.getElementById("inputModal");
    const inputModalOverlay = document.getElementById("inputModalOverlay");
    const inputModalText = document.getElementById("inputModalText");
    const inputModalPct = document.getElementById("inputModalPct");
    const inputModalSendBtn = document.getElementById("inputModalSendBtn");
    const inputModalTitle = document.getElementById("inputModalTitle");

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function getActiveChat() { return state.chats.find(c => c.id === state.activeChatId); }

    /* ====== Render functions ====== */
    function renderChats() {
        chatListArea.innerHTML = "";
        state.chats.forEach(chat => {
            const item = document.createElement("div");
            item.className = `chat-item ${chat.id === state.activeChatId ? 'active' : ''}`;
            item.textContent = chat.name;
            item.onclick = () => { state.activeChatId = chat.id; save(); renderChats(); renderUI(); closeMenu(); };
            chatListArea.appendChild(item);
        });
    }

    function renderUI() {
      const chat = getActiveChat();
      chatArea.innerHTML = "";
      chatArea.oncontextmenu = (e) => openContextMenu(e, null, 'empty');
      setupLongPress(chatArea, (e) => openContextMenu(e, null, 'empty'));

      if (!chat.thoughts.length) { chatArea.innerHTML = '<div class="note">Пока нет мыслей. Нажмите и удерживайте здесь, чтобы добавить первую мысль.</div>'; }

      chat.thoughts.forEach((t, idx) => {
        const group = document.createElement("div"); 
        group.className = "chat-message-group";
        group.style.display = "flex"; group.style.flexDirection = "column"; group.style.gap = "6px";
        group.oncontextmenu = (e) => openContextMenu(e, idx, 'thought');
        setupLongPress(group, (e) => openContextMenu(e, idx, 'thought'));
        
        const neg = document.createElement("div"); neg.className = "chat-message neg"; neg.textContent = t.text || "(пустая мысль)"; 
        const meta = document.createElement("div"); meta.className = "meta-row";
        const pct = document.createElement("div"); pct.textContent = (t.beliefPercent || 0) + "%"; meta.appendChild(pct);
        
        group.appendChild(neg); group.appendChild(meta);

        if (t.distortions && t.distortions.length) { const dline = document.createElement("div"); dline.className = "note"; dline.textContent = "Искажения: " + t.distortions.join(", "); group.appendChild(dline); }
        
        if (t.rationals && t.rationals.length) { 
          t.rationals.forEach((r, ri) => { 
            const rGroup = document.createElement("div");
            rGroup.className = "chat-message-group";
            rGroup.oncontextmenu = (e) => openContextMenu(e, idx, 'rational', ri);
            setupLongPress(rGroup, (e) => openContextMenu(e, idx, 'rational', ri));

            const rat = document.createElement("div"); rat.className = "chat-message rat"; rat.textContent = r.text || "(пусто)"; 
            const rmeta = document.createElement("div"); rmeta.className = "meta-row rat-meta"; 
            const rpct = document.createElement("div"); rpct.textContent = (r.percent || 0) + "%"; 
            rmeta.appendChild(rpct); 
            rGroup.appendChild(rat);
            rGroup.appendChild(rmeta);
            group.appendChild(rGroup);
          }); 
        }
        chatArea.appendChild(group);
      });
      scrollToBottom();
    }

    // Эта функция предотвращает выделение текста на мобильных
    function setupLongPress(element, callback) {
        let touchTimeout;
        let isLongPress = false;

        element.addEventListener('touchstart', (e) => {
            touchTimeout = setTimeout(() => {
                isLongPress = true;
                callback(e);
            }, 500);
        });

        element.addEventListener('touchend', (e) => {
            clearTimeout(touchTimeout);
            if(isLongPress) {
                e.preventDefault(); // Предотвращаем стандартное поведение (выделение/клик)
                isLongPress = false;
            }
        });

        element.addEventListener('touchmove', () => {
            clearTimeout(touchTimeout);
            isLongPress = false;
        });
    }

    function render() { renderUI(); }
    function scrollToBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

    /* ====== Context Menu Functions ====== */
    function openContextMenu(e, tIdx, type, rIdx = null) {
        e.preventDefault();
        closeContextMenu();

        const menuItems = [];
        if (type === 'thought') {
            menuItems.push({ name: "Редактировать мысль", action: () => openInputModal('editThought', tIdx) });
            menuItems.push({ name: "+ Рационал", action: () => openInputModal('newRational', tIdx) });
            menuItems.push({ name: "Искажения", action: () => openDistortionPanel(tIdx) });
            menuItems.push({ name: "Удалить мысль", action: () => deleteItem(tIdx, type) });
        } else if (type === 'rational') {
            menuItems.push({ name: "Редактировать рационал", action: () => openInputModal('editRational', tIdx, rIdx) });
            menuItems.push({ name: "Удалить рационал", action: () => deleteItem(tIdx, type, rIdx) });
        } else if (type === 'empty') {
            menuItems.push({ name: "Добавить мысль", action: () => openInputModal('newThought') });
        }

        contextMenu.innerHTML = "";
        menuItems.forEach(item => {
            const itemEl = document.createElement("div"); itemEl.className = "menu-item"; itemEl.textContent = item.name;
            itemEl.onclick = () => { item.action(); closeContextMenu(); };
            contextMenu.appendChild(itemEl);
        });

        const clickX = e.clientX || (e.changedTouches ? e.changedTouches[0].clientX : 0);
        const clickY = e.clientY || (e.changedTouches ? e.changedTouches[0].clientY : 0);
        contextMenu.style.top = `${clickY}px`; contextMenu.style.left = `${clickX}px`;
        contextMenuOverlay.classList.add("open"); contextMenu.classList.add("open");

        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight) { contextMenu.style.top = `${window.innerHeight - menuRect.height - 10}px`; }
            if (menuRect.right > window.innerWidth) { contextMenu.style.left = `${window.innerWidth - menuRect.width - 10}px`; contextMenu.style.transformOrigin = 'top right'; }
        }, 0);
    }

    function closeContextMenu() {
        contextMenuOverlay.classList.remove("open"); contextMenu.classList.remove("open");
        contextMenu.style.transformOrigin = 'top left';
    }
    contextMenuOverlay.onclick = closeContextMenu;

    function deleteItem(tIdx, type, rIdx = null) {
        const chat = getActiveChat();
        if (type === 'thought') { chat.thoughts.splice(tIdx, 1); } 
        else if (type === 'rational') { chat.thoughts[tIdx].rationals.splice(rIdx, 1); }
        save(); renderUI();
    }


    /* ====== Input Modal Functions ====== */

    function openInputModal(modeType, tIdx = null, rIdx = null) {
        inputModalMode = { type: modeType, tIdx, rIdx };
        inputModalText.value = ''; inputModalPct.value = '';
        
        switch (modeType) {
            case 'newThought': inputModalTitle.textContent = 'Новая мысль'; inputModalText.placeholder = 'Опиши автоматическую негативную мысль...'; break;
            case 'newRational': inputModalTitle.textContent = 'Новый рационал'; inputModalText.placeholder = 'Впишите новую рациональную мысль...'; break;
            case 'editThought':
                const t = getActiveChat().thoughts[tIdx];
                inputModalTitle.textContent = 'Редактировать мысль'; inputModalText.value = t.text; inputModalPct.value = t.beliefPercent; break;
            case 'editRational':
                const r = getActiveChat().thoughts[tIdx].rationals[rIdx];
                inputModalTitle.textContent = 'Редактировать рационал'; inputModalText.value = r.text; inputModalPct.value = r.percent; break;
        }

        inputModalOverlay.classList.add('open'); inputModal.classList.add('open');
        setTimeout(() => { 
            inputModalText.focus(); 
            autoExpandTextarea(inputModalText);
        }, 300);
    }

    function closeInputModal() {
        inputModalOverlay.classList.remove('open'); inputModal.classList.remove('open');
        inputModalText.blur(); inputModalPct.blur();
    }
    inputModalOverlay.onclick = closeInputModal;

    function handleInputModalSubmit() {
        const text = inputModalText.value.trim();
        let belief = parseInt(inputModalPct.value, 10);
        if (!text) return;
        if (isNaN(belief)) belief = 0; belief = Math.max(0, Math.min(100, belief));
        const chat = getActiveChat();
        const { type, tIdx, rIdx } = inputModalMode;

        if (type === 'newThought') { chat.thoughts.push({ text, beliefPercent: belief, distortions: [], rationals: [] }); } 
        else if (type === 'newRational') { chat.thoughts[tIdx].rationals.push({ text, percent: belief }); } 
        else if (type === 'editThought') { chat.thoughts[tIdx].text = text; chat.thoughts[tIdx].beliefPercent = belief; } 
        else if (type === 'editRational') { chat.thoughts[tIdx].rationals[rIdx].text = text; chat.thoughts[tIdx].rationals[rIdx].percent = belief; }

        save(); render(); closeInputModal();
    }
    inputModalSendBtn.onclick = handleInputModalSubmit;

    inputModalText.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (inputModalPct.value.trim() === "" && document.activeElement === inputModalText) { inputModalPct.focus(); } else { handleInputModalSubmit(); }
      }
    });
    inputModalPct.addEventListener("keydown", function(e) { if (e.key === "Enter") { e.preventDefault(); handleInputModalSubmit(); } });

    function autoExpandTextarea(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
    inputModalText.addEventListener('input', () => autoExpandTextarea(inputModalText));


    /* ====== General Functions ====== */
    function openDistortionPanel(idx){
      distortionContent.innerHTML = "";
      CHEATS.forEach(c => {
          const item = document.createElement("div"); item.className = "cheat-item"; item.textContent = c;
          item.onclick = () => {
              const chat = getActiveChat(); const t = chat.thoughts[idx]; t.distortions = t.distortions || [];
              if(!t.distortions.includes(c)) t.distortions.push(c); save(); render(); closeDistortionPanel();
          };
          distortionContent.appendChild(item);
      });
      distortionPanel.classList.add("open");
    }
    function closeDistortionPanel(){ distortionPanel.classList.remove("open"); }
    
    function toggleMenu() {
        const isOpen = sideDrawer.classList.toggle("open");
        document.body.classList.toggle('menu-open', isOpen);
        if (window.innerWidth <= 800) {
            mainGrid.classList.toggle('content-shifted', isOpen);
        } else {
            mainGrid.classList.toggle('shifted', isOpen);
        }
    }
    function closeMenu() {
        sideDrawer.classList.remove("open");
        document.body.classList.remove('menu-open');
        mainGrid.classList.remove('shifted', 'content-shifted');
    }
    
    /* ====== Event Listeners ====== */
    document.getElementById("newChatBtn").onclick = () => {
      const count = state.chats.length + 1; const name = "Чат " + count; const id = Date.now().toString(36);
      state.chats.push({id, name, thoughts: []}); state.activeChatId = id; save(); renderChats(); render();
    };
    menuBtn.onclick = toggleMenu;

    /* ====== Swipe gestures for mobile (Telegram-like) ====== */
    let touchStartX = 0; let touchStartTime = 0;
    document.body.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].clientX; touchStartTime = Date.now(); });
    document.body.addEventListener('touchend', e => {
        const dx = e.changedTouches[0].clientX - touchStartX; const dt = Date.now() - touchStartTime; const speed = Math.abs(dx) / dt;
        const SWIPE_THRESHOLD = 100; const SPEED_THRESHOLD = 0.3;
        if (dx > SWIPE_THRESHOLD || (dx > 50 && speed > SPEED_THRESHOLD)) { if (!sideDrawer.classList.contains('open')) { toggleMenu(); } } 
        else if (dx < -SWIPE_THRESHOLD || (dx < -50 && speed > SPEED_THRESHOLD)) { if (sideDrawer.classList.contains('open')) { closeMenu(); } }
    });

    /* ====== Init ====== */
    renderChats(); 
    render();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<meta charset="utf-8" />

<title>Дневник эмоций с выезжающим меню</title>
<style>
:root{
  --bg:#1a1a2e;
  --card:#2a2a3e;
  --muted:#9aa3b2;
  --neg:#2b5278;
  --rat:#3b3d42;
  --text:#e6e6e6;
  --accent:#4A90E2;
}
body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
.container{ max-width:1200px; margin:0 auto; padding:10px; }
.header{ display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
.add-row{ display:flex; gap:8px; flex-wrap:wrap; }
.input-text{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); min-width:220px; }
.input-num{ width:72px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); text-align:center; }
.grid{ display:grid; grid-template-columns:1fr 320px; gap:20px; transition: margin-left 0.3s; }
.chat-area{ background:rgba(0,0,0,0.04); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px; max-height:70vh; overflow-y:auto; }
.chat-message{ display:block; max-width:85%; padding:10px 14px; border-radius:14px; word-break:break-word; line-height:1.35; }
.chat-message.neg { margin-left:auto; background:var(--neg); color:#fff; border-bottom-right-radius:6px; }
.chat-message.rat { margin-right:auto; background:var(--rat); color:#fff; border-bottom-left-radius:6px; }
.meta-row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; color:var(--muted); font-size:12px; }
.message-controls{ display:flex; gap:6px; align-items:center; }
.icon-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
.icon-btn.ghost{ opacity:0.9; }
.side-drawer{ position:fixed; top:0; left:-220px; width:200px; height:100%; background:var(--card); padding:10px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left 0.3s; z-index:1000; overflow-y:auto; }
.side-drawer.open{ left:0; }
.chat-item{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--text); margin-bottom:6px; }
.chat-item.active{ background:var(--accent); color:#fff; }
.cheat-item{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer; color:var(--text); }
.cheat-item:hover{ transform:translateY(-2px); background:rgba(255,255,255,0.03); }
.note{ color:var(--muted); font-size:13px; margin-top:8px; }
.menu-btn {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1100;
  width: 40px;
  height: 40px;
  font-size: 24px;        /* размер символа */
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.2);
  background: transparent; /* прозрачная */
  color: var(--text);
  font-weight: 600;
  content: "☰";
  font-size: 20px;        /* чуть меньше, полоски тоньше */
  line-height: 1;
}

@media(max-width:800px){ .grid{ grid-template-columns:1fr; } }
 
.side-drawer h3 {
  margin-left: 100px; /* смещение вправо от левого края */
}

.section {
  display: flex;
  flex-direction: column;
  height: 70vh; /* высота чата, можно подстроить */
  position: relative;
}

.chat-area {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 10px; /* чтобы поле ввода не перекрывало сообщения */
}

.fixed-input {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  position: sticky;   /* чтобы оставалось внизу при прокрутке */
  bottom: 0;
  background: var(--card);
  padding: 10px;
  border-radius: 12px 12px 0 0;
}

  
</style>
</head>
<body>

<button class="icon-btn menu-btn" id="menuBtn">☰</button>

<div class="side-drawer" id="sideDrawer">
  <h3>Чаты</h3>
  <div id="chatList"></div>
  <button class="icon-btn" id="newChatBtn" style="margin-top:10px;">+ Новый чат</button>
</div>

<div class="grid">
  <div class="section">
    <div id="chatArea" class="chat-area" aria-live="polite"></div>

    <!-- сюда переносим поле ввода -->
    <div class="add-row fixed-input">
      <input id="newThoughtText" class="input-text" placeholder="Опиши автоматическую негативную мысль..." />
      <input id="newThoughtPct" class="input-num" type="number" min="0" max="100" placeholder="На сколько % веришь?" />
      <button id="addBtn" class="icon-btn">Добавить</button>
    </div>

  </div>
  <aside class="side-section">
    <h3>Шпаргалка — искажения</h3>
    <div id="cheatList"></div>
    <div style="margin-top:10px;" class="small">Клик — добавит искажение в последнюю мысль.</div>
  </aside>
</div>


<script>
/* ====== State ====== */
const STORAGE_KEY="diary_chat_v3";
const CHEATS=["Катастрофизация","Чтение мыслей","Чёрно-белое мышление","Эмоциональное обоснование","Долженствование","Обесценивание положительного","Генерализация","Персонализация","Фильтрация отрицательного","Завышенные стандарты"];
let state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{ chats:[{id:"chat1",name:"Чат 1", thoughts:[]}], activeChatId:"chat1" };

/* ====== UI elements ====== */
const chatArea=document.getElementById("chatArea");
const addBtn=document.getElementById("addBtn");
const newText=document.getElementById("newThoughtText");
const newPct=document.getElementById("newThoughtPct");
const cheatList=document.getElementById("cheatList");
const chatList=document.getElementById("chatList");
const newChatBtn=document.getElementById("newChatBtn");
const sideDrawer=document.getElementById("sideDrawer");
const menuBtn=document.getElementById("menuBtn");

function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }
function getActiveChat(){ return state.chats.find(c=>c.id===state.activeChatId); }

/* ====== Drawer toggle ====== */
menuBtn.onclick=()=>{ sideDrawer.classList.toggle("open"); }

/* ====== Render chats ====== */
function renderChats(){
  chatList.innerHTML="";
  state.chats.forEach(c=>{
    const div=document.createElement("div");
    div.className="chat-item"+(c.id===state.activeChatId?" active":"");
    div.textContent=c.name;
    div.onclick=()=>{ state.activeChatId=c.id; save(); renderChats(); render(); sideDrawer.classList.remove("open"); };
    chatList.appendChild(div);
  });
}
newChatBtn.onclick=()=>{
  const name=prompt("Название нового чата:"); if(!name) return;
  const id=Date.now().toString(36);
  state.chats.push({id,name, thoughts:[]}); state.activeChatId=id; save(); renderChats(); render();
};

/* ====== Render cheats ====== */
function renderCheats(){
  cheatList.innerHTML="";
  CHEATS.forEach(c=>{
    const d=document.createElement("div"); d.className="cheat-item"; d.textContent=c;
    d.onclick=()=>{
      const chat=getActiveChat();
      if(!chat.thoughts.length){ alert("Сначала добавь мысль."); return; }
      const last=chat.thoughts[chat.thoughts.length-1];
      last.distortions=last.distortions||[]; last.distortions.push(c); save(); render();
    };
    cheatList.appendChild(d);
  });
}

/* ====== Render chat messages ====== */
function render(){
  const chat=getActiveChat();
  chatArea.innerHTML="";
  if(!chat.thoughts.length){ chatArea.innerHTML='<div class="small">Пока нет мыслей. Добавь первую справа.</div>'; return; }

  chat.thoughts.forEach((t, idx)=>{
    const group=document.createElement("div"); group.style.display="flex"; group.style.flexDirection="column"; group.style.gap="6px";

    const neg=document.createElement("div"); neg.className="chat-message neg"; neg.textContent=t.text||"(пустая мысль)"; neg.title="Клик — редактировать / удалить"; neg.onclick=()=>editThought(idx);
    const meta=document.createElement("div"); meta.className="meta-row";
    const pct=document.createElement("div"); pct.textContent=(t.beliefPercent||0)+"%"; meta.appendChild(pct);

    const controls=document.createElement("div"); controls.className="message-controls";
    const addRat=document.createElement("button"); addRat.className="icon-btn ghost"; addRat.textContent="+ Рационал"; addRat.onclick=e=>{ e.stopPropagation(); addRational(idx); };
    const del=document.createElement("button"); del.className="icon-btn"; del.textContent="Удалить"; del.onclick=e=>{ e.stopPropagation(); if(confirm("Удалить мысль?")){ chat.thoughts.splice(idx,1); save(); render(); } };
    controls.appendChild(addRat); controls.appendChild(del); meta.appendChild(controls);

    group.appendChild(neg); group.appendChild(meta);

    if(t.distortions&&t.distortions.length){ const dline=document.createElement("div"); dline.className="small"; dline.style.marginBottom="4px"; dline.textContent="Искажения: "+t.distortions.join(", "); group.appendChild(dline); }
    if(t.rationals&&t.rationals.length){ t.rationals.forEach((r,ri)=>{ const rat=document.createElement("div"); rat.className="chat-message rat"; rat.textContent=r.text||"(пусто)"; rat.title="Клик — редактировать рационал"; rat.onclick=()=>editRational(idx,ri); const rmeta=document.createElement("div"); rmeta.className="meta-row"; rmeta.style.justifyContent="flex-start"; const rpct=document.createElement("div"); rpct.textContent=(r.percent||0)+"%"; rmeta.appendChild(rpct); group.appendChild(rat); group.appendChild(rmeta); }); }

    chatArea.appendChild(group);
  });
}

/* ====== Actions ====== */
addBtn.onclick = () => {
  const text = newText.value.trim();
  if(!text){ alert("Напиши мысль"); newText.focus(); return; }

  // parseInt + fallback на 50%
  let pct = parseInt(newPct.value, 10);
  if(isNaN(pct)) pct = 50;
  pct = Math.max(0, Math.min(100, pct));

  getActiveChat().thoughts.push({
    id: Date.now().toString(36),
    text,
    beliefPercent: pct,
    distortions: [],
    rationals: []
  });

  newText.value = "";
  newPct.value = 50;  // сбрасываем ползунок на 50%
  save();
  render();

  // скролл вниз
  setTimeout(()=> chatArea.lastElementChild?.scrollIntoView({behavior:'smooth'}),100);
};


/* ====== Init ====== */
renderChats(); renderCheats(); render();

// кнопка меню
menuBtn.onclick = () => {
  sideDrawer.classList.toggle('open');
};

// свайп
// кнопка меню
menuBtn.onclick = () => sideDrawer.classList.toggle('open');

let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;
let tracking = false;

const SWIPE_THRESHOLD = 120;    // минимальное смещение для свайпа
const SPEED_THRESHOLD = 0.3;    // минимальная скорость
const ANGLE_RATIO = 2;          // dx должен быть в 2 раза больше dy

document.body.addEventListener('touchstart', e => {
  const x = e.touches[0].clientX;
  const y = e.touches[0].clientY;
  if(x < 30 || sideDrawer.classList.contains('open')) {
    touchStartX = x;
    touchStartY = y;
    touchStartTime = Date.now();
    tracking = true;
  }
});

document.body.addEventListener('touchmove', e => {
  if(!tracking) return;
  const dx = e.touches[0].clientX - touchStartX;
  const dy = e.touches[0].clientY - touchStartY;
  
  // если вертикальное движение сильнее, отменяем свайп
  if(Math.abs(dy) > Math.abs(dx)) {
    tracking = false;
  }
});

document.body.addEventListener('touchend', e => {
  if(!tracking) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  const dt = Date.now() - touchStartTime;
  const speed = Math.abs(dx)/dt;

  if(Math.abs(dx) > Math.abs(dy)*ANGLE_RATIO){
    if(dx > SWIPE_THRESHOLD || (dx > 50 && speed > SPEED_THRESHOLD)) sideDrawer.classList.add('open');
    else if(dx < -SWIPE_THRESHOLD || (dx < -50 && speed > SPEED_THRESHOLD)) sideDrawer.classList.remove('open');
  }

  tracking = false;
});

  
  // поле мыслей
newText.addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    e.preventDefault(); // чтобы не создавалась новая строка
    newPct.focus();      // перенос фокуса на ползунок
  }
});

// поле процента веры
newPct.addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    addBtn.click();      // "нажимаем" кнопку добавить
    newText.focus();     // фокус обратно на поле мыслей
  }
});

 function editThought(idx){
  const chat = getActiveChat();
  const t = chat.thoughts[idx];
  const newTextVal = prompt("Изменить мысль:", t.text || "");
  if(newTextVal === null) return;

  let newPctVal = parseInt(prompt("Во сколько процентов веришь? (0-100)", t.beliefPercent || 50),10);
  if(isNaN(newPctVal)) newPctVal = 50;
  newPctVal = Math.max(0, Math.min(100, newPctVal));

  t.text = newTextVal.trim();
  t.beliefPercent = newPctVal;
  save();
  render();
}


</script>
</body>
</html>

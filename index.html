<!DOCTYPE html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta charset="utf-8" />
  <title>Дневник эмоций с выезжающим меню</title>
  <style>
    :root{
      --bg:#1a1a2e;
      --card:#2a2a3e;
      --muted:#9aa3b2;
      --neg:#2b5278;
      --rat:#3b3d42;
      --text:#e6e6e6;
      --accent:#4A90E2;
      --input-bg: rgba(255,255,255,0.08); /* Новый цвет для инпута */
    }
    body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
    body.menu-open { overflow: hidden; }
    
    .grid{ display:grid; grid-template-columns:1fr; gap:0; max-width: 800px; margin: 0 auto; transition: transform 0.3s ease; }
    .side-section { display: none !important; }
    .section { display: flex; flex-direction: column; position: relative; height: 100vh; padding-bottom: 0; }
    
.chat-area {
  overflow-y: scroll; /* или auto */
  scrollbar-width: none; /* Firefox */
  padding-bottom: 80px; /* Дополнительный отступ снизу для новой кнопки */
}
.chat-area::-webkit-scrollbar { width: 0; height: 0; }


    /* Убрал user-select: none с body, чтобы можно было выделять текст в инпуте */
    .chat-message, .chat-message-group, .menu-item { cursor: pointer; } 

    .chat-area{ background:rgba(0,0,0,0.00); padding:40px 14px 80px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; flex: 1; }
    
    .chat-message{ 
        display:block; 
        max-width: 400px; 
        padding:10px 14px; 
        border-radius:14px; 
        word-break:break-word; 
        line-height:1.4; 
        font-size: 15px;
        position: relative; /* Чтобы позиционировать процент */
        padding-bottom: 12px; /* Увеличил паддинг для процента */
    }
    .chat-message.neg { margin-left:auto; background:var(--neg); color:#fff; border-bottom-right-radius:6px; }
    .chat-message.rat { margin-right:auto; background:var(--rat); color:#fff; border-bottom-left-radius:6px; max-width: 50%; } /* Установил max-width и для рационалов */
    .meta-row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; color:var(--muted); font-size:12px; }
    .meta-row.rat-meta { justify-content: flex-start; }
    .distortion-line { color:var(--muted); font-size:12px; margin-top: 4px; margin-bottom: 4px; }
    .distortion-line.neg-dist { text-align: right; }

    .icon-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
    .icon-btn.ghost{ opacity:0.9; }
    .side-drawer{ position:fixed; top:0; left:-350px; width:330px; height:100%; background:var(--card); padding:10px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left 0.3s; z-index:1000; overflow-y:auto; }
    .side-drawer.open{ left:0; }
    .chat-item{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--text); margin-bottom:6px; }
    .chat-item.active{ background:var(--accent); color:#fff; }
    .cheat-item{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer; color:var(--text); }
    
   .note{ 
    color:var(--muted); 
    font-size:13px; 
    padding: 14px; 
    text-align: center; 
    margin-top: 80px; /* отступ сверху для первого сообщения */
}

    .menu-btn { position: fixed; top: 10px; left: 10px; width: 36px; height: 36px; font-size: 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(4px); z-index: 2000; cursor: pointer; }
    .side-drawer h3 { margin-left: 0; }
    
    #distortionPanel { 
        position: fixed; left: 0; right: 0; bottom: 0; height: auto; max-height: 80vh; 
        background: var(--card); border-top-left-radius: 16px; border-top-right-radius: 16px; 
        box-shadow: 0 -4px 15px rgba(0,0,0,0.4); padding: 16px; z-index: 5000; 
        transform: translateY(100%); transition: transform 0.3s ease; overflow-y: auto;
        max-width: 600px; margin: 0 auto; left: 50%; transform: translateX(-50%) translateY(100%);
    }
    #distortionPanel.open { transform: translateX(-50%) translateY(0); }
    @media (max-width: 800px) {
         #distortionPanel { max-width: 100%; left: 0; transform: translateY(100%); }
         #distortionPanel.open { transform: translateY(0); }
    }

    .close-distortion { position: absolute; top: 8px; right: 12px; font-size: 22px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
    .close-distortion:hover { opacity: 1; }

    .grid.shifted { transform: translateX(110px); }

    @media(max-width:800px){ 
      .grid, .grid.shifted { max-width: 100vw; margin: 0; transform: translateX(0); }
      /* max-width убираем отсюда, т.к. он уже в .chat-message */
      .content-shifted { transform: translateX(220px) !important; }
    }

    .context-menu-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 4000; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
    .context-menu-overlay.open { opacity: 1; pointer-events: auto; }
    .context-menu { position: fixed; background: var(--card); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 4001; opacity: 0; transform: scale(0.95); transition: opacity 0.2s ease, transform 0.2s ease; transform-origin: top left; }
    .context-menu.open { opacity: 1; transform: scale(1); }
    .menu-item { padding: 10px 16px; cursor: pointer; font-size: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: rgba(255,255,255,0.05); }

    #inputModalOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 6000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    #inputModalOverlay.open { opacity: 1; pointer-events: auto; }
    #inputModal {
        position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 16px;
        z-index: 6001; transform: translateY(100%); transition: transform 0.3s ease;
        border-top-left-radius: 16px; border-top-right-radius: 16px;
        display: flex; flex-direction: column; gap: 10px;
        max-width: 600px; margin: 0 auto; left: 50%; transform: translateX(-50%) translateY(100%);
    }
    #inputModal.open { transform: translateX(-50%) translateY(0); }
    @media (max-width: 800px) {
         #inputModal { max-width: 100%; left: 0; transform: translateY(100%); }
         #inputModal.open { transform: translateY(0); }
    }

    .input-modal-header { display: flex; justify-content: space-between; align-items: center; }
    .input-modal-actions { display: flex; gap: 8px; align-items: center; } /* Добавил align-items */
    .input-modal-text {
      padding:8px 10px; border-radius:10px; border:none; background:var(--input-bg); color:var(--text); width: 100%;
      resize: none; overflow-y: auto; max-height: 150px; transition: height 0.1s ease-out; box-sizing: border-box;
      font-size: 15px;
    }
    .input-modal-num {
      width:70px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:var(--input-bg); color:var(--text); text-align:center;
      -webkit-appearance: none; appearance: none;
    }
    .input-modal-num::-webkit-outer-spin-button, .input-modal-num::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* Стиль для процента внутри сообщения */
    .belief-percent {
        position: absolute;
        bottom: 2px;
        right: 8px;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
    }
    .chat-message.rat .belief-percent {
        right: auto;
        left: 8px;
    }

    /* Стиль для кнопки добавления новой мысли внизу чата */
    #newThoughtBtn {
        position: fixed;
        bottom: 16px;
        right: 16px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--accent);
        color: white;
        font-size: 24px;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 100;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
  </style>
</head>
<body>

  <div id="distortionPanel">
    <div id="distortionContent"></div>
    <span class="close-distortion" onclick="closeDistortionPanel()">×</span>
  </div>
  
  <button class="icon-btn menu-btn" id="menuBtn">☰</button>

  <div class="side-drawer" id="sideDrawer">
    <h3>Чаты</h3>
    <div id="chatListArea"></div>
    <button id="newChatBtn" class="icon-btn" style="margin-top:10px;">+ Новый чат</button>
  </div>

  <div class="grid" id="mainGrid">
    <div class="section">
        <div id="chatArea" class="chat-area" aria-live="polite"></div>
        <button id="newThoughtBtn" onclick="openInputModal('newThought')">+</button>
    </div>
    <aside class="side-section"></aside>
  </div>

  <div class="context-menu-overlay" id="contextMenuOverlay"></div>
  <div class="context-menu" id="contextMenu"></div>

  <div id="inputModalOverlay"></div>
  <div id="inputModal">
    <div class="input-modal-header">
        <h4 id="inputModalTitle">Новая мысль</h4>
        <div class="input-modal-actions">
            <input id="inputModalPct" class="input-modal-num" type="number" min="0" max="100" placeholder="На %" />
            <button id="inputModalSendBtn" class="icon-btn send-btn">➤</button>
        </div>
    </div>
    <textarea id="inputModalText" class="input-modal-text" rows="1"></textarea>
  </div>


  <script>
    // --- Декларации DOM элементов (в начале скрипта) ---
    const chatArea = document.getElementById("chatArea");
    const sideDrawer = document.getElementById("sideDrawer");
    const menuBtn = document.getElementById("menuBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const chatListArea = document.getElementById("chatListArea");
    const distortionContent = document.getElementById("distortionContent");
    const distortionPanel = document.getElementById("distortionPanel");
    const contextMenuOverlay = document.getElementById("contextMenuOverlay");
    const contextMenu = document.getElementById("contextMenu");
    const inputModalOverlay = document.getElementById("inputModalOverlay");
    const inputModal = document.getElementById("inputModal");
    const inputModalTitle = document.getElementById("inputModalTitle");
    const inputModalText = document.getElementById("inputModalText");
    const inputModalPct = document.getElementById("inputModalPct");
    const inputModalSendBtn = document.getElementById("inputModalSendBtn");
    // const newThoughtBtn = document.getElementById("newThoughtBtn"); // Already declared in HTML onclick

    let inputModalMode = {};
    let chats = [];
    let activeChatId = null;

    // Ваши когнитивные искажения
    const CHEATS = ["Чтение мыслей", "Катастрофизация", "Долженствования", "Навешивание ярлыков", "Фильтрация", "Сверхобобщение", "Персонализация", "Мышление все или ничего"];

    /* ====== Data Management & Storage ====== */
    function save() { localStorage.setItem('emotionDiaryChats', JSON.stringify(chats)); }
    function load() {
        const storedChats = localStorage.getItem('emotionDiaryChats');
        if (storedChats) { chats = JSON.parse(storedChats); } 
        else {
            // Создаем начальный пример, если данных нет
            chats = [{ id: Date.now(), name: "Пример чата", thoughts: [
                { text: "Я никогда не смогу это исправить, все ужасно.", beliefPercent: 90, distortions: ["Катастрофизация", "Все или ничего"], rationals: [
                    { text: "Я справлялся с трудностями раньше, и это не конец света.", percent: 50 }
                ]}
            ]}];
        }
        if (chats.length > 0 && !activeChatId) { activeChatId = chats[0].id; }
        render();
    }

    function getActiveChat() { return chats.find(c => c.id === activeChatId); }

    /* ====== UI Rendering ====== */
    function scrollToBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

    function renderUI() {
      renderChatList();
      const chat = getActiveChat();
      chatArea.innerHTML = "";

      if (!chat || chat.thoughts.length === 0) {
        const note = document.createElement("div");
        note.className = "note";
        note.textContent = "Нажмите + в правом нижнем углу, чтобы добавить первую мысль";
        // attachTouchAndClick(note, 'empty'); // Убрал привязку контекстного меню к пустому месту, теперь есть кнопка +
        chatArea.appendChild(note);
        return;
      }

      chat.thoughts.forEach((t, idx) => {
        const group = document.createElement("div");
        group.className = "chat-message-group";

        // Негативная мысль
        const neg = document.createElement("div");
        neg.className = "chat-message neg";
        neg.textContent = t.text || "(пусто)";
        attachTouchAndClick(neg, 'thought', idx);

        // Процент веры внутри сообщения
        const negPct = document.createElement("span");
        negPct.className = "belief-percent";
        negPct.textContent = t.beliefPercent + "%";
        neg.appendChild(negPct);

        group.appendChild(neg);

        // Искажения
        if (t.distortions && t.distortions.length) {
          t.distortions.forEach(d => {
            const dist = document.createElement("div");
            dist.className = "distortion-line neg-dist";
            dist.textContent = "Искажение: " + d;
            group.appendChild(dist);
          });
        }
        
        // Рационалы внутри мысли
        if (t.rationals && t.rationals.length) { 
            t.rationals.forEach((r, ri) => { 
                const rGroup = document.createElement("div");
                rGroup.className = "chat-message-group";

                const rat = document.createElement("div"); 
                rat.className = "chat-message rat"; 
                rat.textContent = r.text || "(пусто)"; 
                attachTouchAndClick(rat, 'rational', idx, ri);

                // Процент уверенности внутри рационала
                const ratPct = document.createElement("span");
                ratPct.className = "belief-percent";
                ratPct.textContent = (r.percent || 0) + "%"; 
                rat.appendChild(ratPct);

                rGroup.appendChild(rat);
                group.appendChild(rGroup);
            }); 
        }

        chatArea.appendChild(group);
      });

      // Инициация прокрутки после того, как элементы добавлены
      setTimeout(scrollToBottom, 50); 
    }

    function attachTouchAndClick(el, type, tIdx, rIdx = null) {
      let touchTimer;
      let isLongTouch = false;

      el.addEventListener('touchstart', (e) => {
          // Убедимся, что выделение текста не сработает при таче
          e.stopPropagation(); 
          isLongTouch = false;
          touchTimer = setTimeout(() => {
              isLongTouch = true;
              openContextMenu({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY }, tIdx, type, rIdx);
          }, 500); // 500ms для лонг-пресса
      });


      el.addEventListener('touchend', () => {
          clearTimeout(touchTimer);
      });
      el.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // Открываем меню только если это был быстрый клик (не лонг-пресс)
          if (!isLongTouch) {
            openContextMenu(e, tIdx, type, rIdx);
          }
          isLongTouch = false; // Сброс флага
      });
    }

    function renderChatList() {
        chatListArea.innerHTML = "";
        chats.forEach(chat => {
            const item = document.createElement("div");
            item.className = `chat-item ${chat.id === activeChatId ? 'active' : ''}`;
            item.textContent = chat.name;
            item.onclick = () => { activeChatId = chat.id; render(); toggleSideDrawer(); };
            chatListArea.appendChild(item);
        });
    }

    function render() { renderUI(); renderChatList(); }
   

    /* ====== Context Menu Functions ====== */
    function openContextMenu(e, tIdx, type, rIdx = null) {
        // Убираем preventDefault() из e, т.к. мы уже обработали его в attachTouchAndClick
        closeContextMenu();

        const menuItems = [];
        if (type === 'thought') {
            menuItems.push({ name: "Редактировать мысль", action: () => openInputModal('editThought', tIdx) });
            menuItems.push({ name: "+ Рационал", action: () => openInputModal('newRational', tIdx) });
            menuItems.push({ name: "Искажения", action: () => openDistortionPanel(tIdx) });
            menuItems.push({ name: "Удалить мысль", action: () => deleteItem(tIdx, type) });
        } else if (type === 'rational') {
            menuItems.push({ name: "Редактировать рационал", action: () => openInputModal('editRational', tIdx, rIdx) });
            menuItems.push({ name: "Удалить рационал", action: () => deleteItem(tIdx, type, rIdx) });
        } 
        
        if (menuItems.length === 0) return;

        contextMenu.innerHTML = "";
        menuItems.forEach(item => {
            const itemEl = document.createElement("div"); itemEl.className = "menu-item"; itemEl.textContent = item.name;
            itemEl.onclick = (event) => { 
                event.stopPropagation(); // Останавливаем всплытие клика
                item.action(); 
                closeContextMenu(); 
            };
            contextMenu.appendChild(itemEl);
        });

        const clickX = e.clientX || (e.changedTouches ? e.changedTouches[0].clientX : 0); // Исправлено получение координат тача
        const clickY = e.clientY || (e.changedTouches ? e.changedTouches[0].clientY : 0);
        
        contextMenu.style.top = `${clickY}px`; contextMenu.style.left = `${clickX}px`;
        contextMenuOverlay.classList.add("open"); contextMenu.classList.add("open");

        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight) { contextMenu.style.top = `${window.innerHeight - menuRect.height - 10}px`; }
            if (menuRect.right > window.innerWidth) { contextMenu.style.left = `${window.innerWidth - menuRect.width - 10}px`; contextMenu.style.transformOrigin = 'top right'; }
        }, 0);
    }

    function closeContextMenu() {
        contextMenuOverlay.classList.remove("open"); contextMenu.classList.remove("open");
        contextMenu.style.transformOrigin = 'top left';
    }
    contextMenuOverlay.onclick = closeContextMenu;

    function deleteItem(tIdx, type, rIdx = null) {
        if (confirm("Вы уверены, что хотите удалить этот элемент?")) {
            const chat = getActiveChat();
            if (type === 'thought') { chat.thoughts.splice(tIdx, 1); } 
            else if (type === 'rational') { chat.thoughts[tIdx].rationals.splice(rIdx, 1); }
            save(); renderUI();
        }
    }


    /* ====== Input Modal Functions ====== */
    function openInputModal(modeType, tIdx = null, rIdx = null) {
        inputModalMode = { type: modeType, tIdx, rIdx };
        inputModalText.value = ''; inputModalPct.value = '';
        
        switch (modeType) {
            case 'newThought': inputModalTitle.textContent = 'Новая мысль'; inputModalText.placeholder = 'Опиши автоматическую негативную мысль...'; inputModalPct.placeholder = "На %"; break;
            case 'newRational': inputModalTitle.textContent = 'Новый рационал'; inputModalText.placeholder = 'Впишите новую рациональную мысль...'; inputModalPct.placeholder = "На %"; break;
            case 'editThought':
                const t = getActiveChat().thoughts[tIdx];
                inputModalTitle.textContent = 'Редактировать мысль'; inputModalText.value = t.text; inputModalPct.value = t.beliefPercent; break;
            case 'editRational':
                const r = getActiveChat().thoughts[tIdx].rationals[rIdx];
                inputModalTitle.textContent = 'Редактировать рационал'; inputModalText.value = r.text; inputModalPct.value = r.percent; break;
        }

        inputModalOverlay.classList.add('open'); inputModal.classList.add('open');
        setTimeout(() => { inputModalText.focus(); autoExpandTextarea(inputModalText); }, 300);
    }

    function closeInputModal() {
        inputModalOverlay.classList.remove('open'); inputModal.classList.remove('open');
        inputModalText.blur(); inputModalPct.blur();
    }
    inputModalOverlay.onclick = closeInputModal;

    function handleInputModalSubmit() {
        const text = inputModalText.value.trim();
        let belief = parseInt(inputModalPct.value, 10);
        if (!text) return;
        if (isNaN(belief)) belief = 0; belief = Math.max(0, Math.min(100, belief));
        const chat = getActiveChat();
        const { type, tIdx, rIdx } = inputModalMode;

        if (type === 'newThought') { chat.thoughts.push({ text, beliefPercent: belief, distortions: [], rationals: [] }); } 
        else if (type === 'newRational') { chat.thoughts[tIdx].rationals.push({ text, percent: belief }); } 
        else if (type === 'editThought') { chat.thoughts[tIdx].text = text; chat.thoughts[tIdx].beliefPercent = belief; } 
        else if (type === 'editRational') { chat.thoughts[tIdx].rationals[rIdx].text = text; chat.thoughts[tIdx].rationals[rIdx].percent = belief; }

        save(); render(); closeInputModal();
    }
    inputModalSendBtn.onclick = handleInputModalSubmit;

    inputModalText.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (inputModalPct.value.trim() === "" && document.activeElement === inputModalText) { inputModalPct.focus(); } else { handleInputModalSubmit(); }
      }
    });
    inputModalPct.addEventListener("keydown", function(e) { if (e.key === "Enter") { e.preventDefault(); handleInputModalSubmit(); } });
    function autoExpandTextarea(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }
    inputModalText.addEventListener('input', () => autoExpandTextarea(inputModalText));


    /* ====== General Functions ====== */
    function openDistortionPanel(idx){
      distortionContent.innerHTML = "";
      CHEATS.forEach(c => {
          const item = document.createElement("div"); item.className = "cheat-item"; item.textContent = c;
          item.onclick = (e) => {
              e.stopPropagation();
              const chat = getActiveChat(); const t = chat.thoughts[idx]; t.distortions = t.distortions || [];
              if(!t.distortions.includes(c)) t.distortions.push(c); save(); render(); closeDistortionPanel();
          };
          distortionContent.appendChild(item);
      });
      distortionPanel.classList.add('open');
    }

    function closeDistortionPanel() {
        distortionPanel.classList.remove('open');
    }

    function toggleSideDrawer() {
        sideDrawer.classList.toggle('open');
        document.body.classList.toggle('menu-open');
    }
    menuBtn.onclick = toggleSideDrawer;
    
    newChatBtn.onclick = () => {
        const name = prompt("Введите имя нового чата:");
        if (name && name.trim() !== "") {
            const newChat = { id: Date.now(), name: name.trim(), thoughts: [] };
            chats.push(newChat);
            activeChatId = newChat.id;
            save();
            render();
            toggleSideDrawer();
        }
    };


    // --- Инициализация приложения ---
    load();

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Дневник эмоций с выезжающим меню</title>
<style>
:root{
  --bg:#1a1a2e;
  --card:#2a2a3e;
  --muted:#9aa3b2;
  --neg:#2b5278;
  --rat:#3b3d42;
  --text:#e6e6e6;
  --accent:#4A90E2;
}
body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
.container{ max-width:1200px; margin:0 auto; padding:10px; }
.header{ display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
.add-row{ display:flex; gap:8px; flex-wrap:wrap; }
.input-text{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); min-width:220px; }
.input-num{ width:72px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); text-align:center; }
.grid{ display:grid; grid-template-columns:1fr 320px; gap:20px; transition: margin-left 0.3s; }
.chat-area{ background:rgba(0,0,0,0.04); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px; max-height:70vh; overflow-y:auto; }
.chat-message{ display:block; max-width:85%; padding:10px 14px; border-radius:14px; word-break:break-word; line-height:1.35; }
.chat-message.neg { margin-left:auto; background:var(--neg); color:#fff; border-bottom-right-radius:6px; }
.chat-message.rat { margin-right:auto; background:var(--rat); color:#fff; border-bottom-left-radius:6px; }
.meta-row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; color:var(--muted); font-size:12px; }
.message-controls{ display:flex; gap:6px; align-items:center; }
.icon-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
.icon-btn.ghost{ opacity:0.9; }
.side-drawer{ position:fixed; top:0; left:-220px; width:200px; height:100%; background:var(--card); padding:10px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left 0.3s; z-index:1000; overflow-y:auto; }
.side-drawer.open{ left:0; }
.chat-item{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--text); margin-bottom:6px; }
.chat-item.active{ background:var(--accent); color:#fff; }
.cheat-item{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer; color:var(--text); }
.cheat-item:hover{ transform:translateY(-2px); background:rgba(255,255,255,0.03); }
.note{ color:var(--muted); font-size:13px; margin-top:8px; }
.menu-btn{ position:fixed; top:10px; left:10px; z-index:1100; }
@media(max-width:800px){ .grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<button class="icon-btn menu-btn" id="menuBtn">☰ Чаты</button>

<div class="side-drawer" id="sideDrawer">
  <h3>Чаты</h3>
  <div id="chatList"></div>
  <button class="icon-btn" id="newChatBtn" style="margin-top:10px;">+ Новый чат</button>
</div>

<div class="container">
  <div class="header">
    <h1>Негативные мысли</h1>
    <div class="add-row">
      <input id="newThoughtText" class="input-text" placeholder="Опиши автоматическую негативную мысль..." />
      <input id="newThoughtPct" class="input-num" type="number" min="0" max="100" value="50" />
      <button id="addBtn" class="icon-btn">Добавить</button>
    </div>
  </div>

  <div class="grid">
    <div class="section">
      <div id="chatArea" class="chat-area" aria-live="polite"></div>
      <div class="note">Порядок: мысль → искажения → рациональные ответы. Нажми на мысль, чтобы редактировать.</div>
    </div>
    <aside class="side-section">
      <h3>Шпаргалка — искажения</h3>
      <div id="cheatList"></div>
      <div style="margin-top:10px;" class="small">Клик — добавит искажение в последнюю мысль.</div>
    </aside>
  </div>
</div>

<script>
/* ====== State ====== */
const STORAGE_KEY="diary_chat_v3";
const CHEATS=["Катастрофизация","Чтение мыслей","Чёрно-белое мышление","Эмоциональное обоснование","Долженствование","Обесценивание положительного","Генерализация","Персонализация","Фильтрация отрицательного","Завышенные стандарты"];
let state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{ chats:[{id:"chat1",name:"Чат 1", thoughts:[]}], activeChatId:"chat1" };

/* ====== UI elements ====== */
const chatArea=document.getElementById("chatArea");
const addBtn=document.getElementById("addBtn");
const newText=document.getElementById("newThoughtText");
const newPct=document.getElementById("newThoughtPct");
const cheatList=document.getElementById("cheatList");
const chatList=document.getElementById("chatList");
const newChatBtn=document.getElementById("newChatBtn");
const sideDrawer=document.getElementById("sideDrawer");
const menuBtn=document.getElementById("menuBtn");

function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }
function getActiveChat(){ return state.chats.find(c=>c.id===state.activeChatId); }

/* ====== Drawer toggle ====== */
menuBtn.onclick=()=>{ sideDrawer.classList.toggle("open"); }

/* ====== Render chats ====== */
function renderChats(){
  chatList.innerHTML="";
  state.chats.forEach(c=>{
    const div=document.createElement("div");
    div.className="chat-item"+(c.id===state.activeChatId?" active":"");
    div.textContent=c.name;
    div.onclick=()=>{ state.activeChatId=c.id; save(); renderChats(); render(); sideDrawer.classList.remove("open"); };
    chatList.appendChild(div);
  });
}
newChatBtn.onclick=()=>{
  const name=prompt("Название нового чата:"); if(!name) return;
  const id=Date.now().toString(36);
  state.chats.push({id,name, thoughts:[]}); state.activeChatId=id; save(); renderChats(); render();
};

/* ====== Render cheats ====== */
function renderCheats(){
  cheatList.innerHTML="";
  CHEATS.forEach(c=>{
    const d=document.createElement("div"); d.className="cheat-item"; d.textContent=c;
    d.onclick=()=>{
      const chat=getActiveChat();
      if(!chat.thoughts.length){ alert("Сначала добавь мысль."); return; }
      const last=chat.thoughts[chat.thoughts.length-1];
      last.distortions=last.distortions||[]; last.distortions.push(c); save(); render();
    };
    cheatList.appendChild(d);
  });
}

/* ====== Render chat messages ====== */
function render(){
  const chat=getActiveChat();
  chatArea.innerHTML="";
  if(!chat.thoughts.length){ chatArea.innerHTML='<div class="small">Пока нет мыслей. Добавь первую справа.</div>'; return; }

  chat.thoughts.forEach((t, idx)=>{
    const group=document.createElement("div"); group.style.display="flex"; group.style.flexDirection="column"; group.style.gap="6px";

    const neg=document.createElement("div"); neg.className="chat-message neg"; neg.textContent=t.text||"(пустая мысль)"; neg.title="Клик — редактировать / удалить"; neg.onclick=()=>editThought(idx);
    const meta=document.createElement("div"); meta.className="meta-row";
    const pct=document.createElement("div"); pct.textContent=(t.beliefPercent||0)+"%"; meta.appendChild(pct);

    const controls=document.createElement("div"); controls.className="message-controls";
    const addRat=document.createElement("button"); addRat.className="icon-btn ghost"; addRat.textContent="+ Рационал"; addRat.onclick=e=>{ e.stopPropagation(); addRational(idx); };
    const del=document.createElement("button"); del.className="icon-btn"; del.textContent="Удалить"; del.onclick=e=>{ e.stopPropagation(); if(confirm("Удалить мысль?")){ chat.thoughts.splice(idx,1); save(); render(); } };
    controls.appendChild(addRat); controls.appendChild(del); meta.appendChild(controls);

    group.appendChild(neg); group.appendChild(meta);

    if(t.distortions&&t.distortions.length){ const dline=document.createElement("div"); dline.className="small"; dline.style.marginBottom="4px"; dline.textContent="Искажения: "+t.distortions.join(", "); group.appendChild(dline); }
    if(t.rationals&&t.rationals.length){ t.rationals.forEach((r,ri)=>{ const rat=document.createElement("div"); rat.className="chat-message rat"; rat.textContent=r.text||"(пусто)"; rat.title="Клик — редактировать рационал"; rat.onclick=()=>editRational(idx,ri); const rmeta=document.createElement("div"); rmeta.className="meta-row"; rmeta.style.justifyContent="flex-start"; const rpct=document.createElement("div"); rpct.textContent=(r.percent||0)+"%"; rmeta.appendChild(rpct); group.appendChild(rat); group.appendChild(rmeta); }); }

    chatArea.appendChild(group);
  });
}

/* ====== Actions ====== */
addBtn.onclick=()=>{
  const text=newText.value.trim(); if(!text){ alert("Напиши мысль"); return; }
  const pct=Math.max(0,Math.min(100,parseInt(newPct.value||0,10)));
  getActiveChat().thoughts.push({id:Date.now().toString(36), text, beliefPercent:pct, distortions:[], rationals:[]});
  newText.value=""; newPct.value=50; save(); render();
};
function addRational(thIdx){ const text=prompt("Текст рациональной мысли:"); if(text===null)return; const percent=Math.max(0,Math.min(100,parseInt(prompt("Во сколько процентов веришь?","50")||"50",10))); const chat=getActiveChat(); chat.thoughts[thIdx].rationals=chat.thoughts[thIdx].rationals||[]; chat.thoughts[thIdx].rationals.push({id:Date.now().toString(36), text:text.trim(), percent}); save(); render(); }
function editThought(idx){ const chat=getActiveChat(); const t=chat.thoughts[idx]; const newText=prompt("Изменить мысль:", t.text||""); if(newText===null)return; const newPct=Math.max(0,Math.min(100,parseInt(prompt("Во сколько процентов веришь?","50")||"50",10))); t.text=newText.trim(); t.beliefPercent=newPct; save(); render(); }
function editRational(thIdx,rIdx){ const chat=getActiveChat(); const r=chat.thoughts[thIdx].rationals[rIdx]; const txt=prompt("Изменить рационал:", r.text||""); if(txt===null)return; const pct=Math.max(0,Math.min(100,parseInt(prompt("Во сколько процентов веришь?","50")||"50",10))); r.text=txt.trim(); r.percent=pct; save(); render(); }

/* ====== Init ====== */
renderChats(); renderCheats(); render();
</script>
</body>
</html>

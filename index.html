<!DOCTYPE html>
<html lang="ru">
<head>
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<meta charset="utf-8" />

<title>Дневник эмоций с выезжающим меню</title>
<style>
:root{
  --bg:#1a1a2e;
  --card:#2a2a3e;
  --muted:#9aa3b2;
  --neg:#2b5278;
  --rat:#3b3d42;
  --text:#e6e6e6;
  --accent:#4A90E2;
}
body{ margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden; }
.container{ max-width:1200px; margin:0 auto; padding:10px; }
.header{ display:flex; flex-direction:column; gap:10px; margin-bottom:10px; }
.add-row{ display:flex; gap:8px; flex-wrap:wrap; }
.input-text{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); min-width:220px; }
.input-num{ width:72px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:var(--text); text-align:center; }
.grid{ display:grid; grid-template-columns:1fr 320px; gap:20px; transition: margin-left 0.3s; }
.chat-area{ background:rgba(0,0,0,0.04); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; }
.chat-message{ display:block; max-width:85%; padding:10px 14px; border-radius:14px; word-break:break-word; line-height:1.35; }
.chat-message.neg { margin-left:auto; background:var(--neg); color:#fff; border-bottom-right-radius:6px; }
.chat-message.rat { margin-right:auto; background:var(--rat); color:#fff; border-bottom-left-radius:6px; }
.meta-row{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:6px; color:var(--muted); font-size:12px; }
.message-controls{ display:flex; gap:6px; align-items:center; }
.icon-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
.icon-btn.ghost{ opacity:0.9; }
.side-drawer{ position:fixed; top:0; left:-220px; width:200px; height:100%; background:var(--card); padding:10px; box-shadow:2px 0 10px rgba(0,0,0,0.5); transition:left 0.3s; z-index:1000; overflow-y:auto; }
.side-drawer.open{ left:0; }
.chat-item{ padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); cursor:pointer; color:var(--text); margin-bottom:6px; }
.chat-item.active{ background:var(--accent); color:#fff; }
.cheat-item{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer; color:var(--text); }
.cheat-item:hover{ transform:translateY(-2px); background:rgba(255,255,255,0.03); }
.note{ color:var(--muted); font-size:13px; margin-top:8px; }
.menu-btn {
  position: fixed;
  top: 10px;
  left: 10px;
  width: 36px;
  height: 36px;
  font-size: 18px; /* тонкие полоски */
  background: rgba(255,255,255,0.05); /* легкая дымка, не видно границ */
  border: 1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(4px); /* красиво */
  z-index: 2000;
}


@media(max-width:800px){ .grid{ grid-template-columns:1fr; } }
 
.side-drawer h3 {
  margin-left: 100px; /* смещение вправо от левого края */
}

.section {
  display: flex;
  flex-direction: column;
  
  position: relative;
}

/* CSS исправленный */
.chat-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
}

.fixed-input {
  position: fixed;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  background: var(--card);
  padding: 12px 16px;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.4);
  z-index: 2000;
  max-width: 95%;
  min-width: 320px;
}


.input-text {
  max-height: 150px; /* например */
  overflow-y: auto;
}


.input-num {
  width: 70px;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.04);
  background: rgba(255,255,255,0.02);
  color: var(--muted);
  text-align: center;
  font-size: 12px;
}


.input-num::placeholder {
  font-size: 12px;
  color: var(--muted);
}

.chat-area {
  display: flex;
  justify-content: flex-end; /* чтобы новые сообщения снизу */
  overflow-y: auto;
}


.input-num::placeholder {
  font-size: 12px;
  color: var(--muted);
}

#cheatList {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 0.3s ease, opacity 0.3s ease;
}
#cheatList.open {
  max-height: 500px; /* или cheatDiv.scrollHeight в JS */
  opacity: 1;
}

  
#distortionPanel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: 60vh;
  background: var(--card);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
  padding: 16px;
  z-index: 5000;
  transition: transform .35s ease, opacity .25s ease;
}

#distortionPanel {
  transform: translateY(100%);
  transition: transform 0.3s ease;
}
#distortionPanel.open {
  transform: translateY(0);
}


@media(max-width:800px){
  aside.side-section {
     display:none !important;
  }
}

  

.close-distortion {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 22px;
    cursor: pointer;
    opacity: 0.7;
    transition: 0.2s;
}

.close-distortion:hover {
    opacity: 1;
}

.send-btn {
  background: var(--accent);
  color: #fff;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  font-size: 20px;
  display:flex;
  align-items:center;
  justify-content:center;
}
  
  .grid.shifted {
  margin-left: 220px; /* ширина боковой панели */
  transition: margin-left 0.3s;
}
.section {
  display: flex;
  
  height: 100vh; /* весь экран */
  padding-bottom: 80px; /* чтобы панель ввода не перекрывала */
}
.chat-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
 
}


</style>
</head>
<body>

<button class="icon-btn menu-btn" id="menuBtn">☰</button>

<div class="side-drawer" id="sideDrawer">
  <h3>Чаты</h3>
  <div id="chatList"></div>
  <button class="icon-btn" id="newChatBtn" style="margin-top:10px;">+ Новый чат</button>
</div>

<div class="grid">
  <div class="section">
    <div id="chatArea" class="chat-area" aria-live="polite"></div>


  </div>
  <aside class="side-section">
  <h3>Шпаргалка — искажения</h3>
  <button id="toggleCheats" class="icon-btn" style="margin-bottom:6px;">Показать / Скрыть</button>
  <div id="cheatList" style="max-height:0; overflow:hidden; transition:max-height 0.3s ease;"></div>
  <div style="margin-top:10px;" class="small">Клик — добавит искажение в последнюю мысль.</div>
</aside>

</div>


<!-- Фиксированная панель ввода -->
<div class="fixed-input">
  <textarea id="newThoughtText" class="input-text" placeholder="Опиши автоматическую негативную мысль..." rows="1"></textarea>
  <input id="newThoughtPct" class="input-num" type="number" min="0" max="100" placeholder="На сколько % веришь?" />
  <button id="addBtn" class="icon-btn send-btn">➤</button>



<div id="distortionPanel">
    <div id="distortionContent"></div>
    <span class="close-distortion" onclick="closeDistortionPanel()">×</span>
</div>




<script>
/* ====== State ====== */
const STORAGE_KEY="diary_chat_v3";
const CHEATS=["Катастрофизация","Чтение мыслей","Чёрно-белое мышление","Эмоциональное обоснование","Долженствование","Обесценивание положительного","Генерализация","Персонализация","Фильтрация отрицательного","Завышенные стандарты"];
let state=JSON.parse(localStorage.getItem(STORAGE_KEY))||{ chats:[{id:"chat1",name:"Чат 1", thoughts:[]}], activeChatId:"chat1" };

/* ====== UI elements ====== */
const chatArea=document.getElementById("chatArea");
const addBtn=document.getElementById("addBtn");
const newText=document.getElementById("newThoughtText");
const newPct=document.getElementById("newThoughtPct");
const cheatList=document.getElementById("cheatList");
const chatList=document.getElementById("chatList");
const newChatBtn=document.getElementById("newChatBtn");
const sideDrawer=document.getElementById("sideDrawer");
const menuBtn=document.getElementById("menuBtn");

function save(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(state)); }
function getActiveChat(){ return state.chats.find(c=>c.id===state.activeChatId); }



/* ====== Render chats ====== */
function renderChats(){
  chatList.innerHTML="";
  state.chats.forEach(c=>{
    const div=document.createElement("div");
    div.className="chat-item"+(c.id===state.activeChatId?" active":"");
    div.textContent=c.name;
    div.onclick=()=>{ state.activeChatId=c.id; save(); renderChats(); render(); sideDrawer.classList.remove("open"); };
    chatList.appendChild(div);
  });
}


/* ====== Render cheats ====== */
function renderCheats(){
  cheatList.innerHTML="";
  CHEATS.forEach(c=>{
    const d=document.createElement("div"); d.className="cheat-item"; d.textContent=c;
    d.onclick=()=>{
      const chat=getActiveChat();
      if(!chat.thoughts.length){ alert("Сначала добавь мысль."); return; }
      const last=chat.thoughts[chat.thoughts.length-1];
     last.distortions = last.distortions || [];
if(!last.distortions.includes(c)) last.distortions.push(c);
 save(); render();
    };
    cheatList.appendChild(d);
  });
}
  

controls.appendChild(distortBtn);
addBtn.onclick = () => {
  const chat = getActiveChat();
  if(!chat) return;
  chat.thoughts.push({ text: newText.value.trim(), beliefPercent: parseInt(newPct.value)||0 });
  newText.value=""; newPct.value="";
  save();
  render();
  scrollToBottom();
};


/* ====== Render chat messages ====== */
function render(){
  const chat=getActiveChat();
  chatArea.innerHTML="";
  if(!chat.thoughts.length){ chatArea.innerHTML='<div class="small">Пока нет мыслей. Добавь первую справа.</div>'; return; }

  chat.thoughts.forEach((t, idx)=>{
    const group=document.createElement("div"); group.style.display="flex"; group.style.flexDirection="column"; group.style.gap="6px";

    const neg=document.createElement("div"); neg.className="chat-message neg"; neg.textContent=t.text||"(пустая мысль)"; neg.title="Клик — редактировать / удалить"; neg.onclick=()=>editThought(idx);
    const meta=document.createElement("div"); meta.className="meta-row";
    const pct=document.createElement("div"); pct.textContent=(t.beliefPercent||0)+"%"; meta.appendChild(pct);

    const controls=document.createElement("div"); controls.className="message-controls";
    const addRat=document.createElement("button"); addRat.className="icon-btn ghost"; addRat.textContent="+ Рационал";
const distortBtn = document.createElement("button");
distortBtn.className = "icon-btn ghost";
distortBtn.textContent = "Искажения";
distortBtn.onclick = (e) => {
    e.stopPropagation();
    closeDistortionPanel(); // <-- закрываем предыдущую
    openDistortionPanel(idx);
};



    controls.appendChild(addRat); controls.appendChild(del); meta.appendChild(controls);

    group.appendChild(neg); group.appendChild(meta);

    if(t.distortions&&t.distortions.length){ const dline=document.createElement("div"); dline.className="small"; dline.style.marginBottom="4px"; dline.textContent="Искажения: "+t.distortions.join(", "); group.appendChild(dline); }
    if(t.rationals&&t.rationals.length){ t.rationals.forEach((r,ri)=>{ const rat=document.createElement("div"); rat.className="chat-message rat"; rat.textContent=r.text||"(пусто)"; rat.title="Клик — редактировать рационал"; rat.onclick=()=>editRational(idx,ri); const rmeta=document.createElement("div"); rmeta.className="meta-row"; rmeta.style.justifyContent="flex-start"; const rpct=document.createElement("div"); rpct.textContent=(r.percent||0)+"%"; rmeta.appendChild(rpct); group.appendChild(rat); group.appendChild(rmeta); }); }

    chatArea.appendChild(group);
  });
}

/* ====== Actions ====== */
newText.value = "";
  newPct.value = "";
  save();
  render();
  scrollToBottom();

  newText.blur();
  newPct.blur();
  document.querySelector(".fixed-input").style.bottom = "12px";
};

// авто-прокрутка при render
const origRender = render;
render = function(...args){
  origRender.apply(this, args);
  setTimeout(scrollToBottom, 50);
};

   function scrollToBottom() {
  chatArea.scrollTop = chatArea.scrollHeight;
   setTimeout(scrollToBottom,50);
}

/* ====== Init ====== */
renderChats(); renderCheats(); render();

 setTimeout(() => { chatArea.scrollTop = 0;
                   setTimeout(scrollToBottom,50);


};






document.body.addEventListener('touchend', e => {
  if(!tracking) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  const dt = Date.now() - touchStartTime;
  const speed = Math.abs(dx)/dt;

  if(Math.abs(dx) > Math.abs(dy)*ANGLE_RATIO){
    if(dx > SWIPE_THRESHOLD || (dx > 50 && speed > SPEED_THRESHOLD)) sideDrawer.classList.add('open');
    else if(dx < -SWIPE_THRESHOLD || (dx < -50 && speed > SPEED_THRESHOLD)) sideDrawer.classList.remove('open');
  }

  tracking = false;
});
  
  function addRational(idx) {
  const chat = getActiveChat();
  const thought = chat.thoughts[idx];
  thought.rationals = thought.rationals || [];
  const rIdx = thought.rationals.length;
  thought.rationals.push({ text: "", percent: 0 });
  save();
  render();

  // переключаем поле ввода на рационал
  editingRational = { thoughtIdx: idx, rationalIdx: rIdx };
  newText.value = ""; 
newText.placeholder = "Впишите новую рациональную мысль...";
newPct.value = "";
newText.focus();
}



  
  // поле мыслей
newText.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    addBtn.click();
  }
});

newPct.addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    addBtn.click();
    newText.focus();
  }
});



 function editThought(idx){
  const chat = getActiveChat();
  const t = chat.thoughts[idx];
  const newTextVal = prompt("Изменить мысль:", t.text || "");
  if(newTextVal === null) return;

  let newPctVal = parseInt(prompt("Во сколько процентов веришь? (0-100)", t.beliefPercent ?? ""),10);

  if(isNaN(newPctVal)) newPctVal = 50;
  newPctVal = Math.max(0, Math.min(100, newPctVal));

  t.text = newTextVal.trim();
  t.beliefPercent = newPctVal;
  save();
  render();
}

newText.addEventListener("input", () => {
  newText.style.height = "auto";
  newText.style.height = newText.scrollHeight + "px";
});

newChatBtn.onclick = () => {
  const count = state.chats.length + 1;
  const name = "Чат " + count;
  const id = Date.now().toString(36);
  state.chats.push({id, name, thoughts: []});
  state.activeChatId = id;
  save();
  renderChats();
  render();
};

let editingRational = null; // null = ввод мысли, иначе {thoughtIdx, rationalIdx}
  
 const toggleCheatsBtn = document.getElementById("toggleCheats");
const cheatDiv = document.getElementById("cheatList");

toggleCheatsBtn.onclick = () => {
  if(cheatDiv.classList.contains("open")){
    cheatDiv.classList.remove("open");
    cheatDiv.style.maxHeight = "0px";
  } else {
    cheatDiv.classList.add("open");
    cheatDiv.style.maxHeight = cheatDiv.scrollHeight + "px";
  }
  
};


function adjustChatPadding(){
    chatArea.style.paddingBottom = document.querySelector(".fixed-input").offsetHeight + 20 + "px";
}
window.addEventListener("resize", adjustChatPadding);
adjustChatPadding();

window.addEventListener("resize", adjustChatPadding);



    content.innerHTML = "";

    CHEATS.forEach(c => {
        const item = document.createElement("div");
        item.className = "cheat-item";
        item.textContent = c;
        item.onclick = () => {
            closeDistortionPanel();
            const chat = getActiveChat();
            const t = chat.thoughts[thoughtIdx];
            t.distortions = t.distortions || [];
            if(!t.distortions.includes(c)) t.distortions.push(c);

            save();
            render();
        };
        content.appendChild(item);
    });

    panel.classList.add("open");
}

// закрытие свайпом вниз для панели искажений
const panel = document.getElementById("distortionPanel");
let startY = 0;

panel.addEventListener("touchstart", e => {
    startY = e.touches[0].clientY;
});

panel.addEventListener("touchmove", e => {
    const currentY = e.touches[0].clientY;
    const diff = currentY - startY;
    if (diff > 60) {
        closeDistortionPanel();
        e.preventDefault();
    }
});



// закрытие свайпом вниз
document.getElementById("distortionPanel").addEventListener("click", e=>{
    if(e.target.id === "distortionPanel") closeDistortionPanel();
});
 
function openDistortionPanel(idx){
    const panel = document.getElementById("distortionPanel");
    panel.classList.add("open");
}
function closeDistortionPanel(){
    document.getElementById("distortionPanel").classList.remove("open");
}

 
// скрываем клаву на телефонах
if(/Android|iPhone/i.test(navigator.userAgent)){
    setTimeout(() => {
        newText.blur();
        newPct.blur();
    }, 100); // немного больше задержка
}

menuBtn.onclick = e => {
  e.stopPropagation();
  sideDrawer.classList.toggle('open');
  document.querySelector('.grid').classList.toggle('shifted');
};


</script>
</body>
</html>
